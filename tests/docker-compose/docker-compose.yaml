# https://docs.docker.com/compose/compose-file/compose-file-v3/
---
version: '3.9'

services:

  traefik:
    image: traefik:latest
    ports:
    - "5000:8080" # Traefik console
    - "8080:1000" # Payara http
    - "4848:1001" # Payara admin
    - "8161:1002" # ActiveMQ console
    environment:
      TRAEFIK_API: "true"
      TRAEFIK_API_INSECURE: "true"
      TRAEFIK_PROVIDERS_DOCKER: "true"
      TRAEFIK_PROVIDERS_DOCKER_DEFAULTRULE: "Host(`localhost`)||Host(`127.0.0.1`)" # HTTP default rule
      TRAEFIK_PROVIDERS_DOCKER_EXPOSEDBYDEFAULT: "false"
      TRAEFIK_ENTRYPOINTS_payara: "true"
      TRAEFIK_ENTRYPOINTS_admin: "true"
      TRAEFIK_ENTRYPOINTS_queue: "true"
      TRAEFIK_ENTRYPOINTS_payara_ADDRESS: ":1000"
      TRAEFIK_ENTRYPOINTS_admin_ADDRESS: ":1001"
      TRAEFIK_ENTRYPOINTS_queue_ADDRESS: ":1002"
      TRAEFIK_SERVERSTRANSPORT_INSECURESKIPVERIFY: "true" # Default to trust any backend certificates when using https
    volumes:
    - "/var/run/docker.sock:/var/run/docker.sock:ro"

  activemq:
    image: kdsda/activemq:latest
    labels:
    - "traefik.enable=true"
    - "traefik.http.routers.activemq0.entrypoints=queue"
    - "traefik.http.routers.activemq0.service=activemq0"
    - "traefik.http.services.activemq0.loadbalancer.server.port=8161"
    - "traefik.http.services.activemq0.loadbalancer.server.scheme=http"
  payara:
    image: local/payara:latest
    environment:
      PATH_PREBOOT_COMMANDS: /tmp/preboot.asadmin
      PATH_POSTBOOT_COMMANDS: /tmp/postboot.asadmin
    labels:
    - "traefik.enable=true"
    - "traefik.http.routers.payara0.entrypoints=payara"
    - "traefik.http.routers.payara0.service=payara0"
    - "traefik.http.services.payara0.loadbalancer.server.port=8080"
    - "traefik.http.services.payara0.loadbalancer.server.scheme=http"
    - "traefik.tcp.routers.payara1.entrypoints=admin"
    - "traefik.tcp.routers.payara1.rule=HostSNI(`localhost`)||HostSNI(`127.0.0.1`)"
    - "traefik.tcp.routers.payara1.tls.passthrough=true"
    - "traefik.tcp.routers.payara1.service=payara1"
    - "traefik.tcp.services.payara1.loadbalancer.server.port=4848"
    volumes:
    - "./files/logback.xml:/tmp/logback.xml:ro"
    - "./files/preboot.asadmin:/tmp/preboot.asadmin:ro"
    - "./files/postboot.asadmin:/tmp/postboot.asadmin:ro"
    - "./files/binaries/activemq-rar.rar:/tmp/activemq-rar.rar:ro"
    - "./files/binaries/payara-logback-delegation.jar:/tmp/payara-logback-delegation.jar:ro"
    - "./files/binaries/payara-logback-libs.jar:/tmp/payara-logback-libs.jar:ro"
    - "./files/binaries/logstash-logback-encoder.jar:/tmp/logstash-logback-encoder.jar:ro"
    - "./files/binaries/mssql-jdbc.jre11.jar:/tmp/mssql-jdbc.jre11.jar:ro"
    - "./files/binaries/postgresql.jar:/tmp/postgresql.jar:ro"
...
